const lightModeIcon = /* html */ `
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 22 22">
  <path d="M11 16C9.61667 16 8.4375 15.5125 7.4625 14.5375C6.4875 13.5625 6 12.3833 6 11C6 9.61667 6.4875 8.4375 7.4625 7.4625C8.4375 6.4875 9.61667 6 11 6C12.3833 6 13.5625 6.4875 14.5375 7.4625C15.5125 8.4375 16 9.61667 16 11C16 12.3833 15.5125 13.5625 14.5375 14.5375C13.5625 15.5125 12.3833 16 11 16ZM1 12C0.716667 12 0.479167 11.9042 0.2875 11.7125C0.0958333 11.5208 0 11.2833 0 11C0 10.7167 0.0958333 10.4792 0.2875 10.2875C0.479167 10.0958 0.716667 10 1 10H3C3.28333 10 3.52083 10.0958 3.7125 10.2875C3.90417 10.4792 4 10.7167 4 11C4 11.2833 3.90417 11.5208 3.7125 11.7125C3.52083 11.9042 3.28333 12 3 12H1ZM19 12C18.7167 12 18.4792 11.9042 18.2875 11.7125C18.0958 11.5208 18 11.2833 18 11C18 10.7167 18.0958 10.4792 18.2875 10.2875C18.4792 10.0958 18.7167 10 19 10H21C21.2833 10 21.5208 10.0958 21.7125 10.2875C21.9042 10.4792 22 10.7167 22 11C22 11.2833 21.9042 11.5208 21.7125 11.7125C21.5208 11.9042 21.2833 12 21 12H19ZM11 4C10.7167 4 10.4792 3.90417 10.2875 3.7125C10.0958 3.52083 10 3.28333 10 3V1C10 0.716667 10.0958 0.479167 10.2875 0.2875C10.4792 0.0958333 10.7167 0 11 0C11.2833 0 11.5208 0.0958333 11.7125 0.2875C11.9042 0.479167 12 0.716667 12 1V3C12 3.28333 11.9042 3.52083 11.7125 3.7125C11.5208 3.90417 11.2833 4 11 4ZM11 22C10.7167 22 10.4792 21.9042 10.2875 21.7125C10.0958 21.5208 10 21.2833 10 21V19C10 18.7167 10.0958 18.4792 10.2875 18.2875C10.4792 18.0958 10.7167 18 11 18C11.2833 18 11.5208 18.0958 11.7125 18.2875C11.9042 18.4792 12 18.7167 12 19V21C12 21.2833 11.9042 21.5208 11.7125 21.7125C11.5208 21.9042 11.2833 22 11 22ZM4.65 6.05L3.575 5C3.375 4.81667 3.27917 4.58333 3.2875 4.3C3.29583 4.01667 3.39167 3.775 3.575 3.575C3.775 3.375 4.01667 3.275 4.3 3.275C4.58333 3.275 4.81667 3.375 5 3.575L6.05 4.65C6.23333 4.85 6.325 5.08333 6.325 5.35C6.325 5.61667 6.23333 5.85 6.05 6.05C5.86667 6.25 5.6375 6.34583 5.3625 6.3375C5.0875 6.32917 4.85 6.23333 4.65 6.05ZM17 18.425L15.95 17.35C15.7667 17.15 15.675 16.9125 15.675 16.6375C15.675 16.3625 15.7667 16.1333 15.95 15.95C16.1333 15.75 16.3625 15.6542 16.6375 15.6625C16.9125 15.6708 17.15 15.7667 17.35 15.95L18.425 17C18.625 17.1833 18.7208 17.4167 18.7125 17.7C18.7042 17.9833 18.6083 18.225 18.425 18.425C18.225 18.625 17.9833 18.725 17.7 18.725C17.4167 18.725 17.1833 18.625 17 18.425ZM15.95 6.05C15.75 5.86667 15.6542 5.6375 15.6625 5.3625C15.6708 5.0875 15.7667 4.85 15.95 4.65L17 3.575C17.1833 3.375 17.4167 3.27917 17.7 3.2875C17.9833 3.29583 18.225 3.39167 18.425 3.575C18.625 3.775 18.725 4.01667 18.725 4.3C18.725 4.58333 18.625 4.81667 18.425 5L17.35 6.05C17.15 6.23333 16.9167 6.325 16.65 6.325C16.3833 6.325 16.15 6.23333 15.95 6.05ZM3.575 18.425C3.375 18.225 3.275 17.9833 3.275 17.7C3.275 17.4167 3.375 17.1833 3.575 17L4.65 15.95C4.85 15.7667 5.0875 15.675 5.3625 15.675C5.6375 15.675 5.86667 15.7667 6.05 15.95C6.25 16.1333 6.34583 16.3625 6.3375 16.6375C6.32917 16.9125 6.23333 17.15 6.05 17.35L5 18.425C4.81667 18.625 4.58333 18.7208 4.3 18.7125C4.01667 18.7042 3.775 18.6083 3.575 18.425Z" fill="currentColor"/>
</svg>
`;

const darkModeIcon = /* html */ `
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 18 18">
  <path d="M9 18C6.48333 18 4.35417 17.1292 2.6125 15.3875C0.870833 13.6458 0 11.5167 0 9.00002C0 6.70002 0.75 4.70418 2.25 3.01252C3.75 1.32085 5.66667 0.333349 8 0.0500155C8.21667 0.0166821 8.40833 0.0458488 8.575 0.137515C8.74167 0.229182 8.875 0.350015 8.975 0.500015C9.075 0.650015 9.12917 0.825015 9.1375 1.02502C9.14583 1.22502 9.08333 1.41668 8.95 1.60002C8.66667 2.03335 8.45417 2.49168 8.3125 2.97502C8.17083 3.45835 8.1 3.96668 8.1 4.50002C8.1 6.00002 8.625 7.27501 9.675 8.32502C10.725 9.37502 12 9.90002 13.5 9.90002C14.0167 9.90002 14.5292 9.82502 15.0375 9.67502C15.5458 9.52502 16 9.31668 16.4 9.05002C16.5833 8.93335 16.7708 8.87918 16.9625 8.88752C17.1542 8.89585 17.325 8.94168 17.475 9.02502C17.6417 9.10835 17.7708 9.23335 17.8625 9.40002C17.9542 9.56668 17.9833 9.76668 17.95 10C17.7167 12.3 16.7375 14.2083 15.0125 15.725C13.2875 17.2417 11.2833 18 9 18Z" fill="currentColor"/>
</svg>
`;

class ColorSchemeToggle extends HTMLElement {
  storageKey = "color-scheme-preference";

  template = /* html */ `
		<button>
			<ca-icon glyph="light-mode" format="utility"></ca-icon>
			<span class="visually-hidden">Switch between light and dark modes</span>
		</button>
	`;

  schemes = {
    light: "light",
    dark: "dark",
  };

  scheme = this.schemes.light;

  connectedCallback() {
    this.setInitialScheme();
    this.innerHTML = this.template;
    this.applyScheme();

    const toggle = this.querySelector("button");
    toggle.addEventListener("click", () => {
      this.scheme = this.getOppositeScheme();
      this.applyScheme();
    });
  }

  /**
   * Gets the opposite of the currently set scheme. Useful for toggles.
   * @returns The opposite scheme, as a string.
   */
  getOppositeScheme() {
    return this.scheme === this.schemes.light
      ? this.schemes.dark
      : this.schemes.light;
  }

  /**
   * Gets the initial color-scheme based on combination of mark-up and preferences.
   */
  setInitialScheme() {
    // If user has already used this toggle, honor that choice.
    if (localStorage.getItem(this.storageKey)) {
      this.scheme = localStorage.getItem(this.storageKey);
      return;
    }

    // If not, then check the mark-up for a manually "forced" scheme.
    const root = document.querySelector("html");
    const manualPreset = root.getAttribute("data-color-scheme");
    if (Object.values(this.schemes).includes(manualPreset)) {
      this.scheme = manualPreset;
      return;
    }

    // Finally, if still undetermined, check user agent for the system preference.
    this.scheme = window.matchMedia("(prefers-color-scheme: dark)").matches
      ? this.schemes.dark
      : this.schemes.light;
  }

  /**
   * Apply `this.scheme` to the page, make it real.
   */
  applyScheme() {
    localStorage.setItem(this.storageKey, this.scheme);

    const root = document.querySelector("html");
    root.setAttribute("data-color-scheme", this.scheme);

    const button = this.querySelector("button");
    const icon = this.querySelector("ca-icon");
    const newGlyph =
      this.scheme === this.schemes.light ? "light-mode" : "dark-mode";
    icon.setAttribute("glyph", newGlyph);
  }
}

customElements.define("ca-color-scheme-toggle", ColorSchemeToggle);
